{% extends 'base.html' %}

{% block title %}Match Analysis - {{ match.home_team }} vs {{ match.away_team }}{% endblock %}

{% block content %}
<div class="min-h-screen {% if match.sport == 'football' %}sport-pattern-football{% else %}sport-pattern-tabletennis{% endif %}">
    <!-- Header -->
    <div class="{% if match.sport == 'football' %}gradient-football{% else %}gradient-tabletennis{% endif %} text-white py-8 relative overflow-hidden">
        <div class="absolute inset-0 opacity-10">
            {% if match.sport == 'football' %}
                <div class="absolute top-4 right-8 w-16 h-16 border-2 border-white rounded-full"></div>
            {% else %}
                <div class="absolute top-6 right-12 w-3 h-3 bg-white rounded-full"></div>
            {% endif %}
        </div>
        
        <div class="max-w-6xl mx-auto px-4 relative z-10">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-3 tracking-tight">Match Analysis</h1>
                    <div class="flex items-center space-x-6">
                        <span class="text-xl font-bold">{{ match.home_team.name }}</span>
                        {% if match.home_score is not None and match.away_score is not None %}
                            <span class="text-3xl font-black bg-white/20 px-4 py-2 rounded-xl backdrop-blur-sm">
                                {{ match.home_score }} - {{ match.away_score }}
                            </span>
                        {% endif %}
                        <span class="text-xl font-bold">{{ match.away_team.name }}</span>
                    </div>
                    <p class="text-sm opacity-90 mt-2 font-medium">{{ match.match_date|date:"M d, Y" }} â€¢ {{ match.venue }}</p>
                </div>
                <a href="{% url 'tracker:sport_view' match.sport %}" 
                   class="p-3 hover:bg-white/20 rounded-full transition-all duration-300 backdrop-blur-sm">
                    <i data-lucide="x" class="w-7 h-7"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-8 space-y-10">
        {% if stats %}
            <!-- Performance Statistics Chart -->
            <div class="bg-gradient-to-br from-gray-50/80 to-white/80 rounded-2xl p-8 backdrop-blur-sm border border-gray-200">
                <div class="flex items-center space-x-4 mb-8">
                    <div class="p-3 rounded-xl {% if match.sport == 'football' %}bg-green-100{% else %}bg-blue-100{% endif %}">
                        <i data-lucide="trending-up" class="w-6 h-6 {% if match.sport == 'football' %}text-green-600{% else %}text-blue-600{% endif %}"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Performance Statistics</h2>
                </div>
                <div class="h-80">
                    <canvas id="statsChart"></canvas>
                </div>
            </div>

            <!-- Performance Radar Chart -->
            <div class="bg-gradient-to-br from-gray-50/80 to-white/80 rounded-2xl p-8 backdrop-blur-sm border border-gray-200">
                <div class="flex items-center space-x-4 mb-8">
                    <div class="p-3 rounded-xl {% if match.sport == 'football' %}bg-green-100{% else %}bg-blue-100{% endif %}">
                        <i data-lucide="target" class="w-6 h-6 {% if match.sport == 'football' %}text-green-600{% else %}text-blue-600{% endif %}"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Performance Radar</h2>
                </div>
                <div class="h-80">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
        {% endif %}

        <!-- Top Performers -->
        {% if home_performers or away_performers %}
        <div class="bg-gradient-to-br from-gray-50/80 to-white/80 rounded-2xl p-8 backdrop-blur-sm border border-gray-200">
            <div class="flex items-center space-x-4 mb-8">
                <div class="p-3 rounded-xl {% if match.sport == 'football' %}bg-green-100{% else %}bg-blue-100{% endif %}">
                    <i data-lucide="award" class="w-6 h-6 {% if match.sport == 'football' %}text-green-600{% else %}text-blue-600{% endif %}"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Top Performers</h2>
            </div>
            
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Home Team Performers -->
                <div>
                    <h3 class="font-bold text-xl mb-6 text-gray-800">{{ match.home_team.name }}</h3>
                    <div class="space-y-4">
                        {% for player in home_performers %}
                            <div class="bg-white/80 rounded-xl p-6 border border-gray-200 backdrop-blur-sm hover:shadow-lg transition-all duration-300">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-bold text-lg text-gray-800">{{ player.player_name }}</h4>
                                        {% if player.position %}
                                            <p class="text-sm text-gray-600 font-medium">{{ player.position }}</p>
                                        {% endif %}
                                    </div>
                                    <div class="px-3 py-2 rounded-full text-sm font-bold {% if player.rating >= 8.5 %}bg-green-100 text-green-800{% elif player.rating >= 7.5 %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ player.rating }}
                                    </div>
                                </div>
                                <div class="flex space-x-6 text-sm text-gray-600 font-medium">
                                    {% if match.sport == 'football' %}
                                        <span>Goals: <span class="font-bold text-gray-800">{{ player.goals|default:0 }}</span></span>
                                        <span>Assists: <span class="font-bold text-gray-800">{{ player.assists|default:0 }}</span></span>
                                    {% else %}
                                        <span>Points: <span class="font-bold text-gray-800">{{ player.points_won|default:0 }}</span></span>
                                        <span>Aces: <span class="font-bold text-gray-800">{{ player.aces|default:0 }}</span></span>
                                        <span>Winners: <span class="font-bold text-gray-800">{{ player.winners|default:0 }}</span></span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Away Team Performers -->
                <div>
                    <h3 class="font-bold text-xl mb-6 text-gray-800">{{ match.away_team.name }}</h3>
                    <div class="space-y-4">
                        {% for player in away_performers %}
                            <div class="bg-white/80 rounded-xl p-6 border border-gray-200 backdrop-blur-sm hover:shadow-lg transition-all duration-300">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-bold text-lg text-gray-800">{{ player.player_name }}</h4>
                                        {% if player.position %}
                                            <p class="text-sm text-gray-600 font-medium">{{ player.position }}</p>
                                        {% endif %}
                                    </div>
                                    <div class="px-3 py-2 rounded-full text-sm font-bold {% if player.rating >= 8.5 %}bg-green-100 text-green-800{% elif player.rating >= 7.5 %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ player.rating }}
                                    </div>
                                </div>
                                <div class="flex space-x-6 text-sm text-gray-600 font-medium">
                                    {% if match.sport == 'football' %}
                                        <span>Goals: <span class="font-bold text-gray-800">{{ player.goals|default:0 }}</span></span>
                                        <span>Assists: <span class="font-bold text-gray-800">{{ player.assists|default:0 }}</span></span>
                                    {% else %}
                                        <span>Points: <span class="font-bold text-gray-800">{{ player.points_won|default:0 }}</span></span>
                                        <span>Aces: <span class="font-bold text-gray-800">{{ player.aces|default:0 }}</span></span>
                                        <span>Winners: <span class="font-bold text-gray-800">{{ player.winners|default:0 }}</span></span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if stats %}
<script>
    // Fetch match statistics and create charts
    fetch('{% url "tracker:match_stats_api" match.id %}')
        .then(response => response.json())
        .then(data => {
            // Create Bar Chart
            const statsCtx = document.getElementById('statsChart').getContext('2d');
            new Chart(statsCtx, {
                type: 'bar',
                data: {
                    labels: data.stats_data.map(item => item.stat),
                    datasets: [{
                        label: data.home_team,
                        data: data.stats_data.map(item => item.home),
                        backgroundColor: '{% if match.sport == "football" %}#15803d{% else %}#2563eb{% endif %}',
                        borderRadius: 6
                    }, {
                        label: data.away_team,
                        data: data.stats_data.map(item => item.away),
                        backgroundColor: '{% if match.sport == "football" %}#16a34a{% else %}#3b82f6{% endif %}',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Create Radar Chart
            const radarCtx = document.getElementById('radarChart').getContext('2d');
            new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: data.radar_data.map(item => item.stat),
                    datasets: [{
                        label: data.home_team,
                        data: data.radar_data.map(item => item.home),
                        borderColor: '{% if match.sport == "football" %}#15803d{% else %}#2563eb{% endif %}',
                        backgroundColor: '{% if match.sport == "football" %}rgba(21, 128, 61, 0.3){% else %}rgba(37, 99, 235, 0.3){% endif %}',
                        borderWidth: 3
                    }, {
                        label: data.away_team,
                        data: data.radar_data.map(item => item.away),
                        borderColor: '{% if match.sport == "football" %}#16a34a{% else %}#3b82f6{% endif %}',
                        backgroundColor: '{% if match.sport == "football" %}rgba(22, 163, 74, 0.3){% else %}rgba(59, 130, 246, 0.3){% endif %}',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error fetching match stats:', error));
</script>
{% endif %}
{% endblock %}